<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vfc-nfvo-driver-ems-ems-boco</a> &gt; <a href="index.source.html" class="el_package">org.onap.vfc.nfvo.emsdriver.configmgr</a> &gt; <span class="el_source">ConfigurationManager.java</span></div><h1>ConfigurationManager.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2017 BOCO Corporation.  CMCC Technologies Co., Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.onap.vfc.nfvo.emsdriver.configmgr;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.ConcurrentHashMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jdom.Document;
import org.jdom.Element;
import org.onap.vfc.nfvo.emsdriver.commons.constant.Constant;
import org.onap.vfc.nfvo.emsdriver.commons.model.CollectVo;
import org.onap.vfc.nfvo.emsdriver.commons.model.CrontabVo;
import org.onap.vfc.nfvo.emsdriver.commons.model.EMSInfo;
import org.onap.vfc.nfvo.emsdriver.commons.utils.DriverThread;
import org.onap.vfc.nfvo.emsdriver.commons.utils.StringUtil;
import org.onap.vfc.nfvo.emsdriver.commons.utils.XmlUtil;
import org.onap.vfc.nfvo.emsdriver.northbound.client.HttpClientUtil;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;


<span class="fc" id="L46">public class ConfigurationManager extends DriverThread{</span>
<span class="fc" id="L47">	protected static Log log = LogFactory.getLog(ConfigurationManager.class);</span>
	/**
	 * ESM Cache
	 */
<span class="fc" id="L51">	private static Map&lt;String, EMSInfo&gt; emsInfoCache = new ConcurrentHashMap&lt;String, EMSInfo&gt;();</span>
<span class="fc" id="L52">	private static Map&lt;String, CrontabVo&gt; emsCrontab= new ConcurrentHashMap&lt;String, CrontabVo&gt;();</span>
<span class="fc" id="L53">	private static List&lt;String&gt; emsIdList = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L54">	private static Properties properties = null;</span>
	
<span class="fc" id="L56">	private final static String  config = Constant.SYS_CFG + &quot;config.properties&quot;;</span>
	
	@Override
	public void dispose() {
		
		//this.log.debug(&quot;start loading &quot; + cacheFilePath);
<span class="nc" id="L62">		File file = new File(config);</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">	    if(!file.exists() || !file.isFile()){</span>
<span class="nc" id="L64">	    	log.error(&quot;cacheFilePath &quot; + config+&quot; not exist or is not File&quot;);</span>
<span class="nc" id="L65">	    	return;</span>
	    }
<span class="nc" id="L67">	    InputStream in  = null;</span>
		try{
<span class="nc" id="L69">			properties = new Properties();</span>
<span class="nc" id="L70">	        in = new FileInputStream(file);</span>
<span class="nc" id="L71">	        properties.load(in);</span>
<span class="nc" id="L72">	        Map&lt;String, CrontabVo&gt; emsMap = readCorntab();</span>
	        
<span class="nc" id="L74">	        emsCrontab.putAll(emsMap);</span>
	        
	        //
<span class="nc" id="L77">			new ReceiveSource().start();</span>
<span class="nc" id="L78">		}catch(Exception e) {</span>
<span class="nc" id="L79">			log.error(&quot;read [&quot;+file.getAbsolutePath()+&quot;]Exception :&quot;,e);</span>
		}finally {
<span class="nc bnc" id="L81" title="All 6 branches missed.">			if(in != null) {</span>
				try {
<span class="nc" id="L83">					in.close();</span>
<span class="nc" id="L84">				} catch (Exception e) {</span>
<span class="nc" id="L85">				}</span>
			}
<span class="nc" id="L87">		}</span>
<span class="nc" id="L88">	}</span>
	
	public Map&lt;String, CrontabVo&gt; readCorntab() {
<span class="fc" id="L91">		String path = Constant.SYS_CFG + &quot;crontab.xml&quot;;</span>
<span class="fc" id="L92">		File cfg = new File(path);</span>
<span class="fc" id="L93">		log.debug(&quot;start loading &quot; + path);</span>
<span class="pc bpc" id="L94" title="2 of 4 branches missed.">	    if(!cfg.exists() || !cfg.isFile()){</span>
<span class="nc" id="L95">	    	log.debug(&quot;not exists &quot; + path);</span>
<span class="nc" id="L96">	    	return null;</span>
	    }
<span class="fc" id="L98">	    InputStream is = null;</span>
<span class="fc" id="L99">	    Map&lt;String, CrontabVo&gt; tmpcache = new HashMap&lt;String, CrontabVo&gt;();</span>
	    
	    try {
<span class="fc" id="L102">			is = new FileInputStream(cfg);</span>
<span class="fc" id="L103">			Document doc = XmlUtil.getDocument(is);</span>
			
<span class="fc" id="L105">			Element root = doc.getRootElement();</span>
			
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L108">			List&lt;Element&gt; children = root.getChildren();</span>
			
<span class="fc bfc" id="L110" title="All 2 branches covered.">			for(Iterator&lt;Element&gt; it = children.iterator();it.hasNext();){</span>
<span class="fc" id="L111">				CrontabVo crontabVo = new CrontabVo();</span>
<span class="fc" id="L112">				Element child = it.next();</span>
<span class="fc" id="L113">				String type = child.getAttributeValue(&quot;type&quot;);</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">				if(StringUtil.isBank(type)){</span>
<span class="nc" id="L115">					continue;</span>
				}
<span class="fc" id="L117">				crontabVo.setType(type);</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">				if(Constant.COLLECT_TYPE_ALARM.equalsIgnoreCase(type)){</span>
<span class="fc" id="L119">					boolean iscollect =  Boolean.parseBoolean(child.getAttributeValue(&quot;iscollect&quot;));</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">					if(iscollect){</span>
<span class="fc" id="L121">						crontabVo.setIscollect(iscollect);</span>
					}else{
						continue;
					}
					
<span class="fc" id="L126">					crontabVo.setRead_timeout(child.getChildText(&quot;readtimeout&quot;));</span>
<span class="fc" id="L127">				}else{</span>
<span class="fc" id="L128">					String crontab = child.getAttributeValue(&quot;crontab&quot;);</span>
<span class="pc bpc" id="L129" title="1 of 4 branches missed.">					if(!StringUtil.isBank(type) &amp;&amp; !StringUtil.isBank(crontab)){</span>
<span class="fc" id="L130">						crontabVo.setCrontab(crontab);</span>
					}else{
						continue;
					}
<span class="fc" id="L134">					crontabVo.setMatch(child.getChildText(&quot;match&quot;));</span>
<span class="fc" id="L135">					crontabVo.setGranularity(child.getChildText(&quot;granularity&quot;));</span>
				}
<span class="fc" id="L137">				tmpcache.put(type.toUpperCase(), crontabVo);</span>
<span class="fc" id="L138">			}</span>
			
<span class="nc" id="L140">		} catch (Exception e) {</span>
<span class="nc" id="L141">			log.error(&quot;load crontab.xml is error &quot;+StringUtil.getStackTrace(e));</span>
		}finally{
<span class="nc" id="L143">			try {</span>
<span class="pc bpc" id="L144" title="5 of 6 branches missed.">				if(is != null){</span>
<span class="pc" id="L145">					is.close();</span>
<span class="pc" id="L146">					is = null;</span>
				}
<span class="nc" id="L148">			} catch (Exception e2) {</span>
<span class="pc" id="L149">			}</span>
<span class="pc" id="L150">			cfg = null;</span>
<span class="pc" id="L151">		}</span>
<span class="fc" id="L152">		return tmpcache;</span>
	}


	public  void readcfg(){
<span class="fc" id="L157">		String path = Constant.SYS_CFG + &quot;EMSInfo.xml&quot;;</span>
<span class="fc" id="L158">		File cfg = new File(path);</span>
<span class="fc" id="L159">		log.debug(&quot;start loading &quot; + path);</span>
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">	    if(!cfg.exists() || !cfg.isFile()){</span>
<span class="nc" id="L161">	    	log.debug(&quot;not exists &quot; + path);</span>
<span class="nc" id="L162">	    	return;</span>
	    }
	   
        
<span class="fc" id="L166">	    InputStream is = null;</span>
<span class="fc" id="L167">	    Map&lt;String, EMSInfo&gt; tmpcache = new HashMap&lt;String, EMSInfo&gt;();</span>
	    
	    try {
<span class="fc" id="L170">			is = new FileInputStream(cfg);</span>
<span class="fc" id="L171">			Document doc = XmlUtil.getDocument(is);</span>
			
<span class="fc" id="L173">			Element root = doc.getRootElement();</span>
			
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L176">			List&lt;Element&gt; children = root.getChildren();</span>
			
<span class="fc bfc" id="L178" title="All 2 branches covered.">			for(Iterator&lt;Element&gt; it = children.iterator();it.hasNext();){</span>
<span class="fc" id="L179">				EMSInfo emsInfo = new EMSInfo();</span>
<span class="fc" id="L180">				Element child = it.next();</span>
<span class="fc" id="L181">				String name = child.getAttributeValue(&quot;name&quot;);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">				if(StringUtil.isBank(name)){</span>
<span class="nc" id="L183">					continue;</span>
				}
<span class="fc" id="L185">				emsInfo.setName(name);</span>
				
//				tmpcache.put(name, emsInfo);
				
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L190">				List&lt;Element&gt; collectList = child.getChildren();</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">				for(Element collect : collectList){</span>
					
<span class="fc" id="L193">					CollectVo collectVo = new CollectVo();</span>
					
<span class="fc" id="L195">					String type = collect.getAttributeValue(&quot;type&quot;);</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">					if(&quot;alarm&quot;.equalsIgnoreCase(type)){</span>
<span class="fc" id="L197">						boolean iscollect =  Boolean.parseBoolean(collect.getAttributeValue(&quot;iscollect&quot;));</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">						if(iscollect){</span>
<span class="nc" id="L199">							collectVo.setIscollect(iscollect);</span>
						}else{
							continue;
						}
<span class="nc" id="L203">						collectVo.setType(type);</span>
<span class="nc" id="L204">						collectVo.setIP(collect.getChildText(&quot;ip&quot;));</span>
<span class="nc" id="L205">						collectVo.setPort(collect.getChildText(&quot;port&quot;));</span>
<span class="nc" id="L206">						collectVo.setUser(collect.getChildText(&quot;user&quot;));</span>
<span class="nc" id="L207">						collectVo.setPassword(collect.getChildText(&quot;password&quot;));</span>
<span class="nc" id="L208">						collectVo.setRead_timeout(collect.getChildText(&quot;readtimeout&quot;));</span>
<span class="nc" id="L209">					}else{</span>
<span class="fc" id="L210">						String crontab = collect.getAttributeValue(&quot;crontab&quot;);</span>
<span class="pc bpc" id="L211" title="1 of 4 branches missed.">						if(!StringUtil.isBank(type) &amp;&amp; !StringUtil.isBank(crontab)){</span>
<span class="fc" id="L212">							collectVo.setType(type);</span>
<span class="fc" id="L213">							collectVo.setCrontab(crontab);</span>
						}else{
							continue;
						}
<span class="fc" id="L217">						collectVo.setIP(collect.getChildText(&quot;ip&quot;));</span>
<span class="fc" id="L218">						collectVo.setPort(collect.getChildText(&quot;port&quot;));</span>
<span class="fc" id="L219">						collectVo.setUser(collect.getChildText(&quot;user&quot;));</span>
<span class="fc" id="L220">						collectVo.setPassword(collect.getChildText(&quot;password&quot;));</span>
<span class="fc" id="L221">						collectVo.setRemotepath(collect.getChildText(&quot;remotepath&quot;));</span>
<span class="fc" id="L222">						collectVo.setMatch(collect.getChildText(&quot;match&quot;));</span>
<span class="fc" id="L223">						collectVo.setPassive(collect.getChildText(&quot;passive&quot;));</span>
<span class="fc" id="L224">						collectVo.setFtptype(collect.getChildText(&quot;ftptype&quot;));</span>
<span class="fc" id="L225">						collectVo.setGranularity(collect.getChildText(&quot;granularity&quot;));</span>
					}
				
<span class="fc" id="L228">					emsInfo.putCollectMap(type, collectVo);</span>
<span class="fc" id="L229">				}</span>
<span class="fc" id="L230">				tmpcache.put(name, emsInfo);</span>
<span class="fc" id="L231">			}</span>
<span class="fc" id="L232">			emsInfoCache.putAll(tmpcache);</span>
			
<span class="fc" id="L234">			File file = new File(config);</span>
<span class="pc bpc" id="L235" title="2 of 4 branches missed.">		    if(!file.exists() || !file.isFile()){</span>
<span class="nc" id="L236">		    	log.error(&quot;cacheFilePath &quot; + config+&quot; not exist or is not File&quot;);</span>
<span class="nc" id="L237">		    	return;</span>
		    }
<span class="fc" id="L239">		    InputStream in  = null;</span>
			try{
<span class="fc" id="L241">				properties = new Properties();</span>
<span class="fc" id="L242">		        in = new FileInputStream(file);</span>
<span class="fc" id="L243">		        properties.load(in);</span>
<span class="nc" id="L244">			}catch (Exception e) {</span>
<span class="nc" id="L245">				e.printStackTrace();</span>
<span class="fc" id="L246">			}</span>
<span class="nc" id="L247">		} catch (Exception e) {</span>
<span class="nc" id="L248">			log.error(&quot;load EMSInfo.xml is error &quot;+StringUtil.getStackTrace(e));</span>
		}finally{
<span class="pc" id="L250">			tmpcache.clear();</span>
			try {
<span class="pc bpc" id="L252" title="7 of 8 branches missed.">				if(is != null){</span>
<span class="pc" id="L253">					is.close();</span>
<span class="pc" id="L254">					is = null;</span>
				}
<span class="nc" id="L256">			} catch (Exception e2) {</span>
<span class="pc" id="L257">			}</span>
<span class="pc" id="L258">			cfg = null;</span>
<span class="pc" id="L259">		}</span>
<span class="fc" id="L260">	}</span>
	
	
	public static synchronized List&lt;EMSInfo&gt; getAllEMSInfos(){
<span class="fc" id="L264">		List&lt;EMSInfo&gt; list = new ArrayList&lt;EMSInfo&gt;();</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">		for(EMSInfo emsinfo :emsInfoCache.values()){</span>
<span class="fc" id="L266">			list.add(emsinfo);</span>
<span class="fc" id="L267">		}</span>
<span class="fc" id="L268">		return list;</span>
	}
	
	public static synchronized EMSInfo getEMSInfoByName(String emsName){
<span class="fc" id="L272">		EMSInfo emsInfo= emsInfoCache.get(emsName);</span>
<span class="fc" id="L273">		return emsInfo;</span>
	}
	
	public  static synchronized Properties getProperties() {
<span class="fc" id="L277">		return properties;</span>
	}
	
<span class="nc" id="L280">	class ReceiveSource extends Thread{</span>
<span class="nc" id="L281">		long timeStamp = System.currentTimeMillis();</span>
		
		public void run() {
			while(true){
				
				try {
<span class="nc bnc" id="L287" title="All 2 branches missed.">					if(System.currentTimeMillis() - timeStamp &gt; Constant.ONEMINUTE){</span>
<span class="nc" id="L288">						timeStamp = System.currentTimeMillis();</span>
<span class="nc" id="L289">						log.debug(&quot;ReceiveSource run&quot;);</span>
					}
					//get emsId list
<span class="nc" id="L292">					List&lt;String&gt; emsIds = this.getEmsIdList();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">					if(emsIds.size() &gt; 0){</span>
<span class="nc" id="L294">						emsIdList.clear();</span>
<span class="nc" id="L295">						emsIdList.addAll(emsIds);</span>
					}
					
<span class="nc bnc" id="L298" title="All 2 branches missed.">					for(String emsId : emsIdList){</span>
						//get emsInfo by emsId 
<span class="nc" id="L300">						Map&lt;String, EMSInfo&gt; emsInfoMap = this.getEmsInfo(emsId);</span>
						
<span class="nc" id="L302">						emsInfoCache.putAll(emsInfoMap);</span>
<span class="nc" id="L303">					}</span>
					
					
					//
<span class="nc bnc" id="L307" title="All 2 branches missed.">					if(emsInfoCache.size() &gt; 0){</span>
<span class="nc" id="L308">						Thread.sleep(30*60*1000);</span>
					}else{
<span class="nc" id="L310">						Thread.sleep(60*1000);</span>
					}
<span class="nc" id="L312">				} catch (Exception e) {</span>
					try {
<span class="nc" id="L314">						Thread.sleep(60*1000);</span>
<span class="nc" id="L315">					} catch (InterruptedException e1) {</span>
<span class="nc" id="L316">						e1.printStackTrace();</span>
<span class="nc" id="L317">					}</span>
<span class="nc" id="L318">					log.error(&quot;ReceiveSource exception&quot;,e);</span>
<span class="nc" id="L319">				}</span>
			}
		}

		private Map&lt;String, EMSInfo&gt; getEmsInfo(String emsId) {
<span class="nc" id="L324">			Map&lt;String, EMSInfo&gt; tmpcache = new ConcurrentHashMap&lt;String, EMSInfo&gt;();</span>
<span class="nc" id="L325">			String msbAddress = properties.getProperty(&quot;msbAddress&quot;);</span>
<span class="nc" id="L326">			String emstUrl = properties.getProperty(&quot;esr_emsUrl&quot;);</span>
			//set emsId to url
<span class="nc" id="L328">			emstUrl = String.format(emstUrl, emsId);</span>
<span class="nc" id="L329">			String getemstUrl = &quot;http://&quot;+msbAddress+emstUrl;</span>
<span class="nc" id="L330">			String emsResult = HttpClientUtil.doGet(getemstUrl, Constant.ENCODING_UTF8);</span>
<span class="nc" id="L331">			log.debug(getemstUrl+&quot; result=&quot;+emsResult);</span>
<span class="nc" id="L332">			JSONObject reagobj = JSONObject.parseObject(emsResult);</span>
			
<span class="nc" id="L334">			JSONObject  esr_system_info_list = reagobj.getJSONObject(&quot;esr-system-info-list&quot;);</span>
<span class="nc" id="L335">			JSONArray esr_system_info = esr_system_info_list.getJSONArray(&quot;esr-system-info&quot;);</span>
<span class="nc" id="L336">			Iterator&lt;Object&gt; it = esr_system_info.iterator();</span>
<span class="nc" id="L337">			EMSInfo emsInfo = new EMSInfo();</span>
<span class="nc" id="L338">			emsInfo.setName(emsId);</span>
<span class="nc" id="L339">			tmpcache.put(emsId, emsInfo);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">			while(it.hasNext()){</span>
<span class="nc" id="L341">				Object obj = it.next();</span>
<span class="nc" id="L342">				JSONObject collect = (JSONObject)obj;</span>
<span class="nc" id="L343">				String system_type = (String)collect.get(&quot;system-type&quot;);</span>
<span class="nc" id="L344">				CollectVo collectVo = new CollectVo();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">				if(Constant.COLLECT_TYPE_CM.equalsIgnoreCase(system_type)){</span>
<span class="nc" id="L346">					CrontabVo crontabVo = emsCrontab.get(system_type);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">					if(crontabVo != null){</span>
<span class="nc" id="L348">						collectVo.setType(system_type);</span>
<span class="nc" id="L349">						collectVo.setCrontab(crontabVo.getCrontab());</span>
<span class="nc" id="L350">						collectVo.setIP(collect.getString(&quot;ip-address&quot;));</span>
<span class="nc" id="L351">						collectVo.setPort(collect.getString(&quot;port&quot;));</span>
<span class="nc" id="L352">						collectVo.setUser(collect.getString(&quot;user-name&quot;));</span>
<span class="nc" id="L353">						collectVo.setPassword(collect.getString(&quot;password&quot;));</span>
					
<span class="nc" id="L355">						collectVo.setRemotepath(collect.getString(&quot;remote-path&quot;));</span>
<span class="nc" id="L356">						collectVo.setMatch(crontabVo.getMatch());</span>
<span class="nc" id="L357">						collectVo.setPassive(collect.getString(&quot;passive&quot;));</span>
<span class="nc" id="L358">						collectVo.setGranularity(crontabVo.getGranularity());</span>
					}else{
<span class="nc" id="L360">						log.error(&quot;emsCrontab.get(system_type) result crontabVo is null system_type=[&quot;+system_type+&quot;] emsCrontabMap=&quot;+emsCrontab );</span>
					}
					
					
<span class="nc bnc" id="L364" title="All 2 branches missed.">				}else if(Constant.COLLECT_TYPE_PM.equalsIgnoreCase(system_type)){</span>
<span class="nc" id="L365">					CrontabVo crontabVo = emsCrontab.get(system_type);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">					if(crontabVo != null){</span>
<span class="nc" id="L367">						collectVo.setType(system_type);</span>
<span class="nc" id="L368">						collectVo.setCrontab(crontabVo.getCrontab());</span>
<span class="nc" id="L369">						collectVo.setIP(collect.getString(&quot;ip-address&quot;));</span>
<span class="nc" id="L370">						collectVo.setPort(collect.getString(&quot;port&quot;));</span>
<span class="nc" id="L371">						collectVo.setUser(collect.getString(&quot;user-name&quot;));</span>
<span class="nc" id="L372">						collectVo.setPassword(collect.getString(&quot;password&quot;));</span>
					
<span class="nc" id="L374">						collectVo.setRemotepath(collect.getString(&quot;remote-path&quot;));</span>
<span class="nc" id="L375">						collectVo.setMatch(crontabVo.getMatch());</span>
<span class="nc" id="L376">						collectVo.setPassive(collect.getString(&quot;passive&quot;));</span>
<span class="nc" id="L377">						collectVo.setGranularity(crontabVo.getGranularity());</span>
					}else{
<span class="nc" id="L379">						log.error(&quot;emsCrontab.get(system_type) result crontabVo is null system_type=[&quot;+system_type+&quot;]&quot; );</span>
					}
<span class="nc bnc" id="L381" title="All 2 branches missed.">				}else if(Constant.COLLECT_TYPE_ALARM.equalsIgnoreCase(system_type)){</span>
<span class="nc" id="L382">					CrontabVo crontabVo = emsCrontab.get(system_type);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">					if(crontabVo != null){</span>
<span class="nc" id="L384">						collectVo.setIscollect(crontabVo.isIscollect());</span>
<span class="nc" id="L385">						collectVo.setType(system_type);</span>
<span class="nc" id="L386">						collectVo.setIP(collect.getString(&quot;ip-address&quot;));</span>
<span class="nc" id="L387">						collectVo.setPort(collect.getString(&quot;port&quot;));</span>
<span class="nc" id="L388">						collectVo.setUser(collect.getString(&quot;user-name&quot;));</span>
<span class="nc" id="L389">						collectVo.setPassword(collect.getString(&quot;password&quot;));</span>
<span class="nc" id="L390">						collectVo.setRead_timeout(crontabVo.getRead_timeout());</span>
					}else{
<span class="nc" id="L392">						log.error(&quot;emsCrontab.get(system_type) result crontabVo is null system_type=[&quot;+system_type+&quot;]&quot;);</span>
					}
					
					
<span class="nc" id="L396">				}else{</span>
<span class="nc" id="L397">					log.error(&quot;ems system-type =&quot;+system_type+&quot; &quot;);</span>
				}
				
<span class="nc" id="L400">				emsInfo.putCollectMap(system_type, collectVo);</span>
<span class="nc" id="L401">			}</span>
<span class="nc" id="L402">			return tmpcache;</span>
		}

		private List&lt;String&gt; getEmsIdList() {
<span class="nc" id="L406">			List&lt;String&gt; emsIds = new ArrayList&lt;String&gt;();</span>
			//http
<span class="nc" id="L408">			String msbAddress = properties.getProperty(&quot;msbAddress&quot;);</span>
<span class="nc" id="L409">			String url = properties.getProperty(&quot;esr_ems_listUrl&quot;);</span>
<span class="nc" id="L410">			String getemsListUrl = &quot;http://&quot;+msbAddress+url;</span>
			
<span class="nc" id="L412">			String result = HttpClientUtil.doGet(getemsListUrl, Constant.ENCODING_UTF8);</span>
<span class="nc" id="L413">			log.debug(getemsListUrl+&quot; result=&quot;+result);</span>
<span class="nc" id="L414">			JSONObject reagobj = JSONObject.parseObject(result);</span>
<span class="nc" id="L415">			JSONArray  esr_emsIds = reagobj.getJSONArray(&quot;esr-ems&quot;);</span>
<span class="nc" id="L416">			Iterator&lt;Object&gt; it = esr_emsIds.iterator();</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">			while(it.hasNext()){</span>
<span class="nc" id="L418">				Object obj = it.next();</span>
<span class="nc" id="L419">				JSONObject emsId = (JSONObject)obj;</span>
<span class="nc" id="L420">				String emsIdStr = (String)emsId.get(&quot;ems-id&quot;);</span>
<span class="nc" id="L421">				emsIds.add(emsIdStr);</span>
<span class="nc" id="L422">			}</span>
<span class="nc" id="L423">			return emsIds;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>